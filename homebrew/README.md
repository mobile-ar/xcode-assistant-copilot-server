# Homebrew Tap for xcode-assistant-copilot-server

This directory contains the Homebrew formula for [xcode-assistant-copilot-server](https://github.com/mobile-ar/xcode-assistant-copilot-server).

## Setting Up the Tap Repository

To distribute via Homebrew, create a separate GitHub repository named **`homebrew-xcode-assistant-copilot-server`** under the `mobile-ar` organization.

### 1. Create the tap repository

```sh
gh repo create mobile-ar/homebrew-xcode-assistant-copilot-server --public --description "Homebrew tap for xcode-assistant-copilot-server"
```

### 2. Initialize the tap repository

```sh
git clone git@github.com:mobile-ar/homebrew-xcode-assistant-copilot-server.git
cd homebrew-xcode-assistant-copilot-server
mkdir -p Formula
```

### 3. Copy the formula

Copy `Formula/xcode-assistant-copilot-server.rb` from this directory into the tap repository:

```sh
cp /path/to/xcode-assistant-copilot-server/homebrew/Formula/xcode-assistant-copilot-server.rb Formula/
```

### 4. Commit and push the tap

```sh
cd homebrew-xcode-assistant-copilot-server
git add Formula/xcode-assistant-copilot-server.rb
git commit -m "Add xcode-assistant-copilot-server formula template"
git push origin main
```

### 5. Create and push a tag to trigger a release

Once the CI automation is configured (see below), creating a release is as simple as pushing a tag:

```sh
cd /path/to/xcode-assistant-copilot-server
git tag v1.0.0
git push origin v1.0.0
```

The GitHub Actions workflow will automatically:
- Build and test the project
- Create a GitHub Release with the compiled binary attached
- Download the source tarball, compute its SHA256
- Update the Homebrew formula in the tap repository with the correct URL and checksum

## How Users Install

```sh
brew tap mobile-ar/xcode-assistant-copilot-server
brew install xcode-assistant-copilot-server
```

Or in a single command:

```sh
brew install mobile-ar/xcode-assistant-copilot-server/xcode-assistant-copilot-server
```

## Running as a Service

```sh
brew services start xcode-assistant-copilot-server
```

## CI Automation

The main project includes two GitHub Actions workflows for release automation:

### Primary: `.github/workflows/release.yml`

This is the main release workflow. It is triggered automatically when you **push a tag** matching `v*`.

#### What it does

1. **Builds and tests** the project to ensure the tagged commit is stable.
2. **Builds a release binary** and packages it as a `.tar.gz` archive.
3. **Creates a GitHub Release** from the tag with auto-generated release notes and the binary attached.
4. **Downloads the source tarball** for the tag (automatically generated by GitHub) and computes its SHA256 checksum.
5. **Clones the tap repository** (`mobile-ar/homebrew-xcode-assistant-copilot-server`).
6. **Copies the formula template** from `homebrew/Formula/` in the main project and patches in the correct tarball URL and SHA256.
7. **Commits and pushes** the updated formula to the tap repository.

#### How to release

```sh
git tag v1.2.0
git push origin v1.2.0
```

That's it. The workflow handles everything else.

### Fallback: `.github/workflows/release-homebrew.yml`

This workflow updates the Homebrew formula when a **GitHub Release is manually published** (non-prerelease). It also supports **manual dispatch** via the Actions tab, where you can provide a tag name (e.g. `v1.2.0`) to re-run the formula update without creating a new release.

Use this as a fallback if the primary workflow's Homebrew update step fails, or if you need to manually re-sync the formula.

### Required secret: `HOMEBREW_TAP_TOKEN`

Both workflows need **write access** to the tap repository. GitHub Actions' built-in `GITHUB_TOKEN` is scoped to the current repository only, so you must provide a separate personal access token that can push to the tap repo. This token is stored as an **encrypted repository secret** named `HOMEBREW_TAP_TOKEN`.

#### Step 1: Create a fine-grained personal access token

GitHub recommends fine-grained tokens over classic tokens because they can be scoped to specific repositories with minimal permissions.

You can use [this pre-filled link](https://github.com/settings/personal-access-tokens/new?name=homebrew-tap-updater&description=Allows+CI+to+push+formula+updates+to+the+Homebrew+tap+repo&target_name=mobile-ar&contents=write) to create the token with the correct settings pre-populated, or follow the manual steps below:

1. Go to [github.com](https://github.com) and click your **profile picture** (top-right) → **Settings**.
2. In the left sidebar, click **Developer settings**.
3. Under **Personal access tokens**, click **Fine-grained tokens**.
4. Click **Generate new token**.
5. Fill in the fields:

   | Field | Value |
   |---|---|
   | **Token name** | `homebrew-tap-updater` (or any descriptive name) |
   | **Expiration** | Choose a duration (e.g. 90 days, 1 year, or no expiration). You will need to regenerate and update the secret when it expires. |
   | **Description** | `Allows CI to push formula updates to the Homebrew tap repo` |
   | **Resource owner** | Select **`mobile-ar`** (the organization). If `mobile-ar` is an org, it must allow fine-grained tokens — an org admin can enable this under **Organization settings → Personal access tokens → Settings**. |

6. Under **Repository access**, select **Only select repositories**, then pick **`homebrew-xcode-assistant-copilot-server`** from the dropdown. This ensures the token cannot access any other repository.

7. Under **Permissions → Repository permissions**, set:

   | Permission | Access level | Why |
   |---|---|---|
   | **Contents** | **Read and write** | Required to push commits (the updated formula) to the tap repository. |
   | **Metadata** | **Read-only** | Automatically selected; required for basic repo access. |

   Leave all other permissions at **No access**.

8. Click **Generate token**.
9. **Copy the token immediately** — GitHub will only show it once.

#### Step 2: Add the token as a repository secret

The token must be stored as an encrypted secret in the **main project** repository (not the tap repo), so the GitHub Actions workflow can use it.

1. Go to the main project repository: [github.com/mobile-ar/xcode-assistant-copilot-server](https://github.com/mobile-ar/xcode-assistant-copilot-server).
2. Click **Settings** (tab at the top of the repo).
3. In the left sidebar, expand **Secrets and variables** and click **Actions**.
4. Click **New repository secret**.
5. Fill in:

   | Field | Value |
   |---|---|
   | **Name** | `HOMEBREW_TAP_TOKEN` |
   | **Secret** | Paste the personal access token you copied in Step 1. |

6. Click **Add secret**.

Both workflows reference this secret as `${{ secrets.HOMEBREW_TAP_TOKEN }}`. GitHub encrypts it at rest and masks it in logs.

#### Step 3: Verify the setup

1. Create a tag and push it:
   ```sh
   git tag v1.0.0
   git push origin v1.0.0
   ```
2. Go to the **Actions** tab on the main project and watch the **Release** workflow run.
3. Once it completes, verify:
   - A GitHub Release exists for `v1.0.0` with the binary attached.
   - The tap repository's `Formula/xcode-assistant-copilot-server.rb` has the correct URL and SHA256.
4. Test the installation:
   ```sh
   brew tap mobile-ar/xcode-assistant-copilot-server
   brew install xcode-assistant-copilot-server
   ```

### Token maintenance

- **Expiration**: When the token expires, the workflow will fail with a `403` or `401` error. Generate a new token (repeat Step 1) and update the `HOMEBREW_TAP_TOKEN` secret (repeat Step 2).
- **Rotation**: You can rotate the token at any time by generating a new one and updating the secret. The old token is automatically revoked when you delete it from GitHub's token settings.
- **Revoking**: If the token is compromised, immediately delete it at **GitHub → Settings → Developer settings → Fine-grained tokens** and generate a replacement.